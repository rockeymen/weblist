<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç°çƒ¬è¡Œè€…ï¼šåºŸåœŸä¼ è¯´</title>
    <style>
        :root {
            --bg-color: #050505;
            --main-green: #33ff33;
            --bright-green: #ccffcc;
            --dim-green: #114411;
            --alert-red: #ff4444;
            --highlight-yellow: #ffff00;
            --card-bg: #0e1a0e;
            --slot-bg: #1a1a1a;
            --safe-top: env(safe-area-inset-top, 24px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            background-color: var(--bg-color);
            color: var(--main-green);
            font-family: "Courier New", Courier, monospace;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
        }

        /* CRT æ‰«æçº¿æ»¤é•œ */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* --- é¡¶éƒ¨çŠ¶æ€æ  --- */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            padding: calc(5px + var(--safe-top)) 15px 5px 15px; /* å‡å°‘å†…è¾¹è· */
            background: #000;
            border-bottom: 2px solid var(--dim-green);
            height: auto; 
            box-sizing: border-box;
            align-items: flex-end;
            position: relative;
            z-index: 50;
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
        }

        .stat-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 4px;
            position: relative;
        }

        .stat-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 4px;
        }
        
        .stat-icon { font-size: 22px; margin-bottom: 2px; }
        .stat-label { font-size: 10px; font-weight: bold; opacity: 0.9; }

        /* ç®­å¤´æŒ‡ç¤ºå™¨ */
        .stat-indicator {
            font-size: 20px;
            font-weight: 900;
            height: 20px;
            line-height: 20px;
            text-align: center;
            width: 100%;
            opacity: 0;
            transition: opacity 0.1s;
            position: absolute;
            top: 0; 
            right: 0;
            transform: translate(15px, -5px); 
            pointer-events: none;
            text-shadow: 0 0 5px #000;
        }
        .arrow-up { color: var(--main-green); content: "â–²"; }
        .arrow-down { color: var(--alert-red); content: "â–¼"; }
        .stat-indicator.visible { opacity: 1 !important; }

        .progress-container {
            width: 100%;
            height: 6px;
            background: #222;
            border: 1px solid var(--dim-green);
            border-radius: 2px;
        }

        .progress-fill {
            height: 100%;
            background: var(--main-green);
            width: 50%;
            transition: width 0.3s ease, background-color 0.3s;
        }

        /* --- æ¸¸æˆä¸»åŒºåŸŸ --- */
        .game-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow: hidden;
            padding-top: 10px; 
        }

        .distance-display {
            font-size: 14px;
            font-weight: bold;
            color: var(--bright-green);
            background: rgba(0,0,0,0.8);
            padding: 2px 10px;
            border-radius: 4px;
            border: 1px solid var(--dim-green);
            margin-bottom: 5px;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        /* ç»“æœåé¦ˆæ–‡å­—åŒº */
        .result-message-area {
            min-height: 40px; /* å‡å°é«˜åº¦å ä½ */
            width: 90%;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            font-size: 16px;
            color: var(--highlight-yellow);
            text-shadow: 1px 1px 0 #000;
            pointer-events: none;
            font-weight: bold;
            line-height: 1.2;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }
        .result-message-area.visible { opacity: 1; }

        /* --- å¡ç‰ŒåŒºåŸŸ (æ¯”ä¾‹è°ƒæ•´) --- */
        .card-wrapper {
            width: 85%;
            max-width: 340px;
            height: 360px; /* ç¨å¾®å‡å°æ•´ä½“é«˜åº¦ */
            position: relative;
            transition: transform 0.3s ease-out, opacity 0.3s; 
            z-index: 10;
            flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
        }

        .card {
            width: 100%;
            height: 100%;
            border: 3px solid var(--main-green);
            background: var(--card-bg);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 25px rgba(51, 255, 51, 0.08);
        }

        /* å›¾åƒåŒºå˜å¤§ */
        .card-image-area {
            height: 220px; /* å¢åŠ é«˜åº¦ï¼Œå æ¯”æ›´å¤§ */
            background: #000;
            border-bottom: 2px solid var(--dim-green);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æ–‡å­—åŒºå˜å° */
        .card-text-area {
            flex: 1;
            padding: 10px 15px; /* å‡å°‘å†…è¾¹è· */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 16px; /* å­—ä½“é€‚ä¸­ */
            font-weight: 500;
            line-height: 1.4;
            color: #eeffee;
        }

        /* --- è£…å¤‡æ ç³»ç»Ÿ --- */
        .inventory-section {
            width: 95%;
            max-width: 360px;
            height: 80px; /* é«˜åº¦é€‚ä¸­ */
            display: flex;
            justify-content: space-around;
            z-index: 20;
            margin-top: 10px; /* æ‹‰è¿‘ä¸å¡ç‰Œè·ç¦» */
            margin-bottom: 5px; /* ç•™å‡ºåº•éƒ¨ç©ºé—´ */
            flex-shrink: 0;
        }

        .item-slot {
            width: 70px;
            height: 80px;
            background: var(--slot-bg);
            border: 2px solid #444;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .item-slot.has-item {
            border-color: #448844;
            background: #081808;
        }
        
        .item-slot.preview-highlight {
            border-color: var(--highlight-yellow) !important;
            background-color: #333300 !important;
            box-shadow: 0 0 15px var(--highlight-yellow);
            transform: scale(1.05);
        }

        .item-slot.active-triggered {
            animation: item-flash 0.5s ease-out;
        }

        .item-icon { 
            font-size: 32px;
            margin-bottom: 0; 
            z-index: 1;
        }
        
        .item-name { 
            font-size: 10px;
            color: #88aa88;
            position: absolute;
            bottom: 2px;
            width: 100%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-count-badge { 
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 18px;
            font-weight: 900;
            color: #fff;
            text-shadow: 1px 1px 0 #000;
            z-index: 2;
        }

        /* è£…å¤‡è¯¦æƒ…å¼¹çª— (è°ƒæ•´ä½ç½®) */
        .item-popup {
            position: absolute;
            bottom: 100px; /* é˜²æ­¢é®æŒ¡ */
            background: rgba(0,0,0,0.95);
            border: 2px solid var(--main-green);
            padding: 15px;
            width: 260px;
            text-align: center;
            z-index: 100;
            display: none;
            box-shadow: 0 0 30px #000;
            border-radius: 8px;
        }

        /* å·¦å³é€‰æ‹©æç¤º */
        .fixed-choice-overlay {
            position: absolute;
            top: 120px; 
            font-size: 32px;
            font-weight: bold;
            padding: 10px 20px;
            border: 4px solid;
            border-radius: 8px;
            opacity: 0;
            z-index: 50;
            pointer-events: none;
            background: rgba(0,0,0,0.8);
            transition: opacity 0.1s;
        }
        .choice-left { left: 20px; color: var(--alert-red); border-color: var(--alert-red); transform: rotate(-10deg); }
        .choice-right { right: 20px; color: var(--main-green); border-color: var(--main-green); transform: rotate(10deg); }

        /* --- åº•éƒ¨æŒ‰é’® (ç¼©å°ç‰ˆ) --- */
        .controls {
            /* å‡å°‘ä¸Šä¸‹å†…è¾¹è· */
            padding: 8px 20px calc(8px + var(--safe-bottom)); 
            display: flex;
            justify-content: space-between;
            width: 100%;
            box-sizing: border-box;
            background: #000;
            border-top: 1px solid var(--dim-green);
            flex-shrink: 0;
        }

        .btn {
            background: #050505;
            border: 2px solid var(--dim-green);
            color: var(--main-green);
            /* å‡å°æŒ‰é’®é«˜åº¦ */
            padding: 12px 0; 
            width: 48%;
            font-family: inherit;
            font-size: 18px; /* å­—ä½“ç¨å¾®å‡å° */
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.1s;
        }
        .btn:active { background: var(--main-green); color: black; border-color: var(--main-green); }

        /* ç•Œé¢é®ç½© */
        .screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #050505;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
            padding: 30px;
            box-sizing: border-box;
        }
        .hidden { display: none; }
        
        h1 { font-size: 40px; margin-bottom: 10px; text-shadow: 2px 2px var(--dim-green); }
        .death-title { color: var(--alert-red); font-size: 32px; margin: 20px 0; }
        .story-text { margin-bottom: 30px; line-height: 1.6; font-size: 16px; max-width: 90%; color: #ddd; }

        .slide-out-left { transform: translateX(-150%) rotate(-20deg) !important; opacity: 0; }
        .slide-out-right { transform: translateX(150%) rotate(20deg) !important; opacity: 0; }

        @keyframes item-flash {
            0% { background-color: #fff; border-color: #fff; transform: scale(1.1); }
            100% { background-color: var(--slot-bg); border-color: var(--dim-green); transform: scale(1); }
        }

    </style>
</head>
<body>

<div class="crt-overlay"></div>

<!-- é¡¶éƒ¨çŠ¶æ€æ  -->
<div class="stats-bar">
    <div class="stat-item" id="stat-energy">
        <div class="stat-indicator"></div>
        <div class="stat-header">
            <span class="stat-icon">âš¡</span>
            <span class="stat-label">ä½“åŠ›</span>
        </div>
        <div class="progress-container"><div class="progress-fill" style="width: 50%"></div></div>
    </div>
    <div class="stat-item" id="stat-health">
        <div class="stat-indicator"></div>
        <div class="stat-header">
            <span class="stat-icon">â¤ï¸</span>
            <span class="stat-label">å¥åº·</span>
        </div>
        <div class="progress-container"><div class="progress-fill" style="width: 50%"></div></div>
    </div>
    <div class="stat-item" id="stat-supplies">
        <div class="stat-indicator"></div>
        <div class="stat-header">
            <span class="stat-icon">ğŸ“¦</span>
            <span class="stat-label">ç‰©èµ„</span>
        </div>
        <div class="progress-container"><div class="progress-fill" style="width: 50%"></div></div>
    </div>
    <div class="stat-item" id="stat-sanity">
        <div class="stat-indicator"></div>
        <div class="stat-header">
            <span class="stat-icon">ğŸ§ </span>
            <span class="stat-label">å¿ƒæ™º</span>
        </div>
        <div class="progress-container"><div class="progress-fill" style="width: 50%"></div></div>
    </div>
</div>

<!-- æ¸¸æˆä¸»åŒºåŸŸ -->
<div class="game-container">
    <div class="distance-display">è·ç¦»ç»¿åŒº: <span id="dist-display">1000</span> KM</div>

    <!-- ç»“æœåé¦ˆæ–‡å­—åŒº -->
    <div id="result-message" class="result-message-area"></div>

    <div class="fixed-choice-overlay choice-left" id="choice-left-label">æ‹’ç»</div>
    <div class="fixed-choice-overlay choice-right" id="choice-right-label">æ¥å—</div>

    <div class="card-wrapper" id="card-wrapper">
        <div class="card">
            <div class="card-image-area">
                <canvas id="card-canvas" width="220" height="200"></canvas>
            </div>
            <div class="card-text-area" id="card-desc">
                ç³»ç»Ÿåˆå§‹åŒ–ä¸­...
            </div>
        </div>
    </div>

    <!-- è£…å¤‡æ  -->
    <div class="inventory-section" id="inventory-container">
        <!-- JSç”Ÿæˆæ’æ§½ -->
        <div class="item-slot" onclick="showItemDetail(0)"></div>
        <div class="item-slot" onclick="showItemDetail(1)"></div>
        <div class="item-slot" onclick="showItemDetail(2)"></div>
        <div class="item-slot" onclick="showItemDetail(3)"></div>
    </div>

    <!-- è£…å¤‡è¯¦æƒ…å¼¹çª— -->
    <div id="item-popup" class="item-popup">
        <h3 id="popup-name">è£…å¤‡å</h3>
        <p id="popup-desc">è¯´æ˜æ–‡å­—</p>
        <p style="margin-top:15px; color:#aaa; font-size:12px">ç‚¹å‡»ä»»æ„å¤„å…³é—­</p>
    </div>
</div>

<!-- åº•éƒ¨æ§åˆ¶æŒ‰é’® -->
<div class="controls">
    <button class="btn" onclick="triggerChoice('left')" 
            onmouseenter="showPreview('left')" onmouseleave="hidePreview()">
        â—€ <span id="btn-left-text">å·¦æ»‘</span>
    </button>
    <button class="btn" onclick="triggerChoice('right')"
            onmouseenter="showPreview('right')" onmouseleave="hidePreview()">
        <span id="btn-right-text">å³æ»‘</span> â–¶
    </button>
</div>

<!-- å¼€å§‹ç•Œé¢ -->
<div id="start-screen" class="screen-overlay">
    <h1>ç°çƒ¬è¡Œè€…</h1>
    <div style="font-size:14px; margin-bottom:20px; opacity:0.8; letter-spacing:2px">ASH WALKER: SURVIVAL</div>
    <p class="story-text">
        ç©¿è¶Š 1000 å…¬é‡Œè¾å°„åºŸåœŸã€‚<br>
        ä¿æŒå››é¡¹æ•°å€¼å¹³è¡¡ (0~100)ã€‚<br>
        <br>
        æç¤ºï¼š<br>æŒ‰ä½å¡ç‰Œå·¦å³æ»‘åŠ¨æ—¶ï¼Œ<br>é»„è‰²é«˜äº®è¡¨ç¤ºè£…å¤‡å°†ç”Ÿæ•ˆã€‚
    </p>
    <button class="btn" style="width:200px" onclick="startGame()">å¼€å§‹æ—…ç¨‹</button>
</div>

<!-- æ­»äº¡ç•Œé¢ -->
<div id="game-over-screen" class="screen-overlay hidden">
    <h2 style="color:#666">è¿æ¥ä¸­æ–­</h2>
    <h1 id="death-title" class="death-title">æ­»å› </h1>
    <p id="death-desc" class="story-text">æè¿°</p>
    <p style="font-size:18px">å­˜æ´»è·ç¦»: <span id="final-score" style="color:#fff; font-weight:bold">0</span> KM</p>
    <button class="btn" style="width:200px" onclick="showStartScreen()">è¿”å›é¦–é¡µ</button>
</div>

<!-- é€šå…³ç•Œé¢ -->
<div id="victory-screen" class="screen-overlay hidden">
    <h1 style="color: #ffff00">ç›®æ ‡æŠµè¾¾</h1>
    <p class="story-text">
        é«˜å¢™çš„å¤§é—¨ç¼“ç¼“æ‰“å¼€ã€‚<br>
        ä½ æ´»ä¸‹æ¥äº†ï¼Œå¸¦ç€åºŸåœŸçš„ä¼ è¯´ã€‚
    </p>
    <button class="btn" style="width:200px" onclick="showStartScreen()">è¿”å›é¦–é¡µ</button>
</div>

<script>
    // --- æ¸¸æˆé…ç½® ---
    const CONFIG = {
        totalDistance: 1000,
        kmPerCard: 30
    };

    // --- è£…å¤‡æ•°æ®åº“ ---
    const ITEMS_DB = {
        'knife': { name: 'å¤šåŠŸèƒ½åˆ€', icon: 'ğŸ”ª', desc: 'ã€æ‹¾è’/æˆ˜æ–—ã€‘æ”¶ç›Šå¢åŠ ã€‚', maxUses: 6 },
        'mask': { name: 'é˜²æ¯’é¢å…·', icon: 'ğŸ˜·', desc: 'å¥åº·ä¼¤å®³å‡åŠã€‚', maxUses: 5 },
        'boots': { name: 'å†›ç”¨æˆ˜é´', icon: 'ğŸ¥¾', desc: 'ä½“åŠ›æ¶ˆè€—å‡å°‘ã€‚', maxUses: 8 },
        'radio': { name: 'æ—§æ”¶éŸ³æœº', icon: 'ğŸ“»', desc: 'å‡ ç‡æŠµæ¶ˆå¿ƒæ™ºä¸‹é™ã€‚', maxUses: 5 },
        'medkit_guide': { name: 'æ€¥æ•‘æ‰‹å†Œ', icon: 'ğŸ“–', desc: 'æ²»ç–—æ•ˆæœæå‡ã€‚', maxUses: 4 }
    };

    let state = {
        stats: { energy: 50, health: 50, supplies: 50, sanity: 50 },
        distance: 0,
        currentCard: null,
        isPlaying: false,
        inventory: [] 
    };

    // --- å¡ç‰Œæ•°æ®åº“ ---
    const CARDS = [
        { type: "scavenge", text: "ä¸€å…·å°¸ä½“è„šä¸Šç©¿ç€å®Œå¥½çš„ã€å†›ç”¨æˆ˜é´ã€‘ã€‚", 
          left: { text: "ç©¿ä¸Š", effect: { sanity: -5 }, reward: 'boots', outcome: "é´å­å¾ˆåˆè„šï¼Œè™½ç„¶æœ‰ç‚¹å‘³é“ã€‚" }, 
          right: { text: "ç¦»å¼€", effect: { energy: -2 }, outcome: "ä½ ä¸æƒ³æ‰“æ‰°æ­»è€…ã€‚" } },
        
        { type: "scavenge", text: "åºŸå¼ƒäº”é‡‘åº—è´§æ¶æ·±å¤„è—ç€ä¸€æŠŠã€å¤šåŠŸèƒ½åˆ€ã€‘ã€‚", 
          left: { text: "æ‹¿èµ°", effect: { energy: -5 }, reward: 'knife', outcome: "è¿™æŠŠåˆ€å¾ˆé”‹åˆ©ã€‚" }, 
          right: { text: "æ— è§†", effect: { supplies: 2 }, outcome: "ä½ åªæ‹¿äº†å‡ é¢—èºä¸é’‰ã€‚" } },
        
        { type: "scavenge", text: "é˜²ç©ºæ´å…¥å£æŒ‚ç€ä¸€ä¸ªã€é˜²æ¯’é¢å…·ã€‘ã€‚", 
          left: { text: "æˆ´ä¸Š", effect: { health: -5 }, reward: 'mask', outcome: "æ»¤èŠ¯æœ‰ç‚¹æ—§ï¼Œä½†æ¯”æ²¡æœ‰å¼ºã€‚" }, 
          right: { text: "å¤ªè„", effect: { sanity: -2 }, outcome: "ä¸Šé¢æ»¡æ˜¯éœ‰èŒã€‚" } },

        { type: "enemy", text: "åŒå¤´å˜å¼‚çŠ¬æ­£åœ¨å•ƒé£Ÿè·¯éšœã€‚", 
          left: { text: "å¼€æª", effect: { supplies: -10, energy: -5 }, outcome: "æªå£°å“è·‘äº†å®ƒã€‚" }, 
          right: { text: "å–‚è‚‰", effect: { supplies: -20, health: 0 }, outcome: "å®ƒå¼ç€è‚‰è·‘äº†ã€‚" } },
        
        { type: "enemy", text: "ä¸‰ä¸ªæ å¤ºè€…æ­£åœ¨çƒ¤ç«ï¼Œæ—è¾¹æ”¾ç€èƒŒåŒ…ã€‚", 
          left: { text: "å·è¢­", effect: { health: -20, supplies: 25, sanity: -10 }, outcome: "ä¸€ç•ªè¡€æˆ˜ï¼Œä½ æŠ¢èµ°äº†ç‰©èµ„ã€‚" }, 
          right: { text: "ç»•è·¯", effect: { energy: -15, supplies: -5 }, outcome: "ä½ å°å¿ƒç¿¼ç¿¼åœ°ç»•è¿‡äº†è¥åœ°ã€‚" } },
        
        { type: "scavenge", text: "è‡ªåŠ¨è´©å–æœºé‡Œè¿˜æœ‰ä¸€ç“¶â€œæ ¸å­å¯ä¹â€ã€‚", 
          left: { text: "å–æ‰", effect: { energy: 15, health: -5 }, outcome: "å‘³é“åƒæ´å•çµï¼Œä½†è®©ä½ ç²¾ç¥ä¸€æŒ¯ã€‚" }, 
          right: { text: "ç ¸å¼€", effect: { supplies: 5, energy: -5 }, outcome: "åªæ‰¾åˆ°å‡ ä¸ªç¡¬å¸ã€‚" } },
        
        { type: "scavenge", text: "ä½ å‘ç°äº†ä¸€çªæœªå˜å¼‚çš„é¸Ÿè›‹ã€‚", 
          left: { text: "ç”Ÿåƒ", effect: { supplies: 10, health: -5 }, outcome: "æœ‰ç‚¹è…¥ï¼Œè‚šå­å¼€å§‹éšéšä½œç—›ã€‚" }, 
          right: { text: "ç…®ç†Ÿ", effect: { supplies: 5, energy: -5 }, outcome: "ä¸€é¡¿ä¸é”™çš„æ—©é¤ã€‚" } },

        { type: "event", text: "é…¸é›¨äº‘æ­£åœ¨èšé›†ã€‚", 
          left: { text: "æ‰¾æ©ä½“", effect: { energy: 5, supplies: -10 }, outcome: "ä½ åœ¨æ´ç©´é‡Œèº²äº†åŠå¤©ï¼Œåˆé¥¿åˆå†·ã€‚" }, 
          right: { text: "å¼ºè¡Œèµ¶è·¯", effect: { health: -15, energy: -10 }, outcome: "çš®è‚¤è¢«ç¼çƒ§å¾—ç”Ÿç–¼ã€‚" } },

        { type: "moral", text: "åºŸå¢Ÿä¸‹ä¼ æ¥æ±‚æ•‘å£°ï¼Œä½†é‚£äººçš®è‚¤å·²æºƒçƒ‚ã€‚", 
          left: { text: "æ•‘ä»–", effect: { energy: -15, sanity: 20, health: -10 }, outcome: "ä½ æ•‘äº†ä»–ï¼Œä½†ä¹Ÿæ¥è§¦äº†ç—…èŒã€‚" }, 
          right: { text: "è¡¥ä¸€æª", effect: { sanity: -15, supplies: 5 }, outcome: "è¿™å¯¹ä»–æ¥è¯´æ˜¯ä¸€ç§è§£è„±ã€‚" } },

        { type: "trap", text: "ç©ºæŠ•ç®±å°±åœ¨å‰æ–¹ï¼Œå‘¨å›´å®‰é™å¾—è¯¡å¼‚ã€‚", 
          left: { text: "å†²è¿‡å»", effect: { health: -30 }, outcome: "åœ°é›·ç‚¸é£äº†ä½ çš„è…¿ï¼Œè¿™æ˜¯ä¸ªé™·é˜±ï¼" }, 
          right: { text: "è§‚å¯Ÿ", effect: { supplies: -5 }, outcome: "ä½ å‘ç°äº†ç»Šçº¿ï¼Œå¹¸å¥½æ²¡å»ã€‚" } }
    ];

    // --- ç»“å±€æ–‡æ¡ˆ ---
    const DEATHS = {
        energy_low: { title: "åŠ›ç«­å€’ä¸‹", desc: "ä½ çš„åŒè…¿åƒçŒäº†é“…ï¼Œæœ€ç»ˆç˜«è½¯åœ¨è·¯è¾¹ã€‚" },
        energy_high: { title: "å¿ƒè„éª¤åœ", desc: "æåº¦äº¢å¥‹è®©ä½ çš„å¿ƒè„åƒè¿‡è½½çš„å¼•æ“ä¸€æ ·ç‚¸è£‚ã€‚" },
        health_low: { title: "ç”Ÿå‘½ç»ˆç»“", desc: "åç–½çˆ¬æ»¡äº†å…¨èº«ï¼Œè¾å°„æ·±å…¥éª¨é«“ã€‚" },
        health_high: { title: "åŸºå› å˜å¼‚", desc: "ä½ å˜æˆäº†å¤±å»äººæ€§çš„æ€ªç‰©ã€‚" },
        supplies_low: { title: "é¥¥æ¸´è€Œæ­»", desc: "æ°´å£¶ç©ºäº†ï¼Œä½ åœ¨ç»æœ›ä¸­è„±æ°´è€Œæ­»ã€‚" },
        supplies_high: { title: "äººä¸ºè´¢æ­»", desc: "è´ªå©ªçš„å“å£°å¼•æ¥äº†å¼ºç›—é›†å›¢ã€‚" },
        sanity_low: { title: "è‡ªæˆ‘äº†æ–­", desc: "åºŸåœŸçš„æ®‹é…·å‡»ç©¿äº†ä½ çš„å¿ƒç†é˜²çº¿ã€‚" },
        sanity_high: { title: "ç›²ç›®ç‹‚çƒ­", desc: "ä½ å¾®ç¬‘ç€èµ°è¿›äº†é«˜è¾å°„åŒºæ‹¥æŠ±â€œåœ£å…‰â€ã€‚" }
    };

    // --- æ ¸å¿ƒé€»è¾‘ ---

    function showStartScreen() {
        state.isPlaying = false;
        document.getElementById('start-screen').classList.remove('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('victory-screen').classList.add('hidden');
        showResultMessage("");
        
        state.stats = { energy: 50, health: 50, supplies: 50, sanity: 50 };
        state.distance = 0;
        state.inventory = [];
        updateUI();
        updateInventoryUI();
        document.getElementById('dist-display').innerText = CONFIG.totalDistance;
    }

    function startGame() {
        state.stats = { energy: 50, health: 50, supplies: 50, sanity: 50 };
        state.distance = 0;
        state.inventory = [];
        state.isPlaying = true;
        
        document.getElementById('start-screen').classList.add('hidden');
        updateUI();
        updateInventoryUI();
        document.getElementById('dist-display').innerText = CONFIG.totalDistance;
        loadNextCard();
    }

    function loadNextCard() {
        hidePreview();
        
        const randomIndex = Math.floor(Math.random() * CARDS.length);
        const cardData = CARDS[randomIndex];
        state.currentCard = cardData;

        const cardWrapper = document.getElementById('card-wrapper');
        cardWrapper.style.transition = 'none';
        cardWrapper.style.transform = '';
        cardWrapper.style.opacity = '1';
        void cardWrapper.offsetWidth; 
        
        document.getElementById('card-desc').innerText = cardData.text;
        document.getElementById('choice-left-label').innerText = cardData.left.text;
        document.getElementById('choice-right-label').innerText = cardData.right.text;
        document.getElementById('btn-left-text').innerText = cardData.left.text;
        document.getElementById('btn-right-text').innerText = cardData.right.text;
        
        document.getElementById('choice-left-label').style.opacity = 0;
        document.getElementById('choice-right-label').style.opacity = 0;

        drawCardImage(cardData.type);
    }

    function triggerChoice(direction) {
        if (!state.isPlaying) return;
        const card = state.currentCard;
        const choice = direction === 'left' ? card.left : card.right;
        
        const cardWrapper = document.getElementById('card-wrapper');
        cardWrapper.style.transition = 'transform 0.4s ease-out, opacity 0.4s';
        cardWrapper.classList.add(direction === 'left' ? 'slide-out-left' : 'slide-out-right');

        // åº”ç”¨æ•ˆæœ + è£…å¤‡åˆ¤å®š + è£…å¤‡æ¶ˆè€—
        applyEffects(choice.effect, card.type);

        if (choice.reward) addItem(choice.reward);

        // ç»“æœåé¦ˆ
        let outcomeText = choice.outcome || generateGenericOutcome(choice.effect);
        showResultMessage(outcomeText);

        state.distance += CONFIG.kmPerCard;
        document.getElementById('dist-display').innerText = Math.max(0, CONFIG.totalDistance - state.distance);

        hidePreview();

        setTimeout(() => {
            if (checkGameOver()) return;
            if (checkVictory()) return;
            cardWrapper.classList.remove('slide-out-left', 'slide-out-right');
            loadNextCard();
        }, 500);
    }

    // --- è£…å¤‡è§¦å‘åˆ¤å®š ---
    function shouldItemTrigger(itemId, cardType, effect) {
        if (itemId === 'knife' && (cardType === 'scavenge' || cardType === 'enemy') && effect.supplies > 0) return true;
        if (itemId === 'mask' && effect.health < 0) return true;
        if (itemId === 'boots' && effect.energy < 0) return true;
        if (itemId === 'radio' && effect.sanity < 0) return true;
        if (itemId === 'medkit_guide' && effect.health > 0) return true;
        return false;
    }

    // --- ç»“æœæ–‡å­—åé¦ˆ ---
    let resultTimeout;
    function showResultMessage(text) {
        const el = document.getElementById('result-message');
        el.innerText = text || "";
        
        if (text) {
            el.classList.add('visible');
            if (resultTimeout) clearTimeout(resultTimeout);
            resultTimeout = setTimeout(() => {
                el.classList.remove('visible');
            }, 2500);
        } else {
            el.classList.remove('visible');
        }
    }

    function generateGenericOutcome(effect) {
        let texts = [];
        if (effect.health < 0) texts.push("ä½ å—ä¼¤äº†");
        if (effect.supplies > 0) texts.push("è·å¾—ç‰©èµ„");
        if (effect.supplies < 0) texts.push("æ¶ˆè€—äº†ç‰©èµ„");
        if (effect.sanity < 0) texts.push("ç²¾ç¥å—æŒ«");
        if (effect.energy < 0) texts.push("æ„Ÿåˆ°ç–²æƒ«");
        return texts.length > 0 ? texts.join("ï¼Œ") + "ã€‚" : "";
    }

    // --- æ•°å€¼ä¸è£…å¤‡åº”ç”¨ ---
    function applyEffects(baseEffect, cardType) {
        let effect = { ...baseEffect };

        state.inventory.forEach((item, index) => {
            if (shouldItemTrigger(item.id, cardType, effect)) {
                let triggered = true;
                
                if (item.id === 'knife') effect.supplies += 5;
                else if (item.id === 'mask') effect.health = Math.floor(effect.health / 2);
                else if (item.id === 'boots') effect.energy = Math.min(0, effect.energy + 3);
                else if (item.id === 'radio') {
                    if (Math.random() < 0.5) triggered = false; 
                    else effect.sanity = 2; 
                }
                else if (item.id === 'medkit_guide') effect.health += 5;

                if (triggered) {
                    item.uses--;
                    triggerInventoryAnim(index); 
                }
            }
        });

        state.inventory = state.inventory.filter(item => item.uses > 0);
        updateInventoryUI();

        for (let key in effect) {
            if (state.stats.hasOwnProperty(key)) {
                state.stats[key] += effect[key];
            }
        }
        updateUI();
    }

    function triggerInventoryAnim(index) {
        const slots = document.querySelectorAll('.item-slot');
        if (slots[index]) {
            slots[index].classList.remove('preview-highlight'); 
            slots[index].classList.add('active-triggered');
            setTimeout(() => {
                slots[index].classList.remove('active-triggered');
            }, 600);
        }
    }

    function addItem(itemId) {
        if (state.inventory.length >= 4) return;
        const dbItem = ITEMS_DB[itemId];
        state.inventory.push({ id: itemId, uses: dbItem.maxUses });
        updateInventoryUI();
    }

    // --- UI æ›´æ–° ---

    function updateUI() {
        updateBar('energy', state.stats.energy);
        updateBar('health', state.stats.health);
        updateBar('supplies', state.stats.supplies);
        updateBar('sanity', state.stats.sanity);
    }

    function updateBar(type, value) {
        const bar = document.querySelector(`#stat-${type} .progress-fill`);
        let displayVal = Math.max(0, Math.min(100, value));
        bar.style.width = displayVal + '%';
        if (value <= 20 || value >= 80) bar.style.backgroundColor = 'var(--alert-red)';
        else bar.style.backgroundColor = 'var(--main-green)';
    }

    function updateInventoryUI() {
        const slots = document.querySelectorAll('.item-slot');
        slots.forEach((slot, index) => {
            slot.innerHTML = '';
            slot.className = 'item-slot'; // reset
            
            if (index < state.inventory.length) {
                const item = state.inventory[index];
                const dbItem = ITEMS_DB[item.id];
                
                slot.classList.add('has-item');
                slot.innerHTML = `
                    <div class="item-icon">${dbItem.icon}</div>
                    <div class="item-name">${dbItem.name}</div>
                    <div class="item-count-badge">${item.uses}</div>
                `;
            }
        });
    }

    function showItemDetail(index) {
        const popup = document.getElementById('item-popup');
        if (index >= state.inventory.length) {
            popup.style.display = 'none';
            return;
        }
        const item = state.inventory[index];
        const dbItem = ITEMS_DB[item.id];
        document.getElementById('popup-name').innerText = dbItem.name;
        document.getElementById('popup-desc').innerText = dbItem.desc;
        popup.style.display = 'block';
    }

    document.addEventListener('click', function(e) {
        if (!document.getElementById('inventory-container').contains(e.target)) {
            document.getElementById('item-popup').style.display = 'none';
        }
    });

    // --- é¢„è§ˆä¸é«˜äº® ---
    function showPreview(direction) {
        if (!state.isPlaying || !state.currentCard) return;
        const effect = direction === 'left' ? state.currentCard.left.effect : state.currentCard.right.effect;
        const cardType = state.currentCard.type;

        // é¡¶éƒ¨ç®­å¤´
        for (let key in state.stats) {
            const indicator = document.querySelector(`#stat-${key} .stat-indicator`);
            indicator.classList.remove('arrow-up', 'arrow-down', 'visible');
            indicator.innerHTML = ''; 

            if (effect[key]) {
                indicator.classList.add('visible');
                if (effect[key] > 0) {
                    indicator.classList.add('arrow-up');
                    indicator.innerHTML = 'â–²';
                } else if (effect[key] < 0) {
                    indicator.classList.add('arrow-down');
                    indicator.innerHTML = 'â–¼';
                }
            }
        }

        // è£…å¤‡é«˜äº® (é¢„è§ˆ)
        const slots = document.querySelectorAll('.item-slot');
        state.inventory.forEach((item, index) => {
            if (slots[index]) {
                if (shouldItemTrigger(item.id, cardType, effect)) {
                    slots[index].classList.add('preview-highlight');
                } else {
                    slots[index].classList.remove('preview-highlight');
                }
            }
        });
    }

    function hidePreview() {
        document.querySelectorAll('.stat-indicator').forEach(el => {
            el.classList.remove('visible');
        });
        document.querySelectorAll('.item-slot').forEach(el => {
            el.classList.remove('preview-highlight');
        });
    }

    // --- ç»˜å›¾ ---
    function drawCardImage(type) {
        const canvas = document.getElementById('card-canvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);
        ctx.strokeStyle = '#33ff33';
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        
        if (type === 'scavenge') {
            ctx.strokeRect(60, 60, 100, 80); // æ”¾å¤§ç®±å­
            ctx.moveTo(60, 60); ctx.lineTo(110, 40); ctx.lineTo(160, 60);
            ctx.moveTo(110, 40); ctx.lineTo(110, 120);
        } else if (type === 'enemy') {
            ctx.moveTo(60, 100); ctx.lineTo(110, 30); ctx.lineTo(160, 100);
            ctx.moveTo(110, 60); ctx.lineTo(110, 120);
            ctx.moveTo(80, 80); ctx.lineTo(140, 80);
        } else if (type === 'moral') {
            ctx.moveTo(110, 40); ctx.lineTo(110, 160);
            ctx.moveTo(60, 80); ctx.lineTo(160, 80);
            ctx.strokeRect(50, 80, 20, 20);
            ctx.strokeRect(150, 80, 20, 20);
        } else if (type === 'trap') {
            ctx.moveTo(110, 30); ctx.lineTo(180, 160); ctx.lineTo(40, 160); ctx.closePath();
            ctx.moveTo(110, 60); ctx.lineTo(110, 110);
            ctx.moveTo(110, 130); ctx.arc(110, 130, 4, 0, Math.PI*2);
        } else {
            ctx.arc(110, 80, 25, Math.PI, 0);
            ctx.lineTo(110, 140);
            ctx.moveTo(110, 160); ctx.arc(110, 160, 4, 0, Math.PI*2);
        }
        ctx.stroke();
    }

    // --- è§¦æ‘¸é€»è¾‘ ---
    const cardWrapper = document.getElementById('card-wrapper');
    const leftLabel = document.getElementById('choice-left-label');
    const rightLabel = document.getElementById('choice-right-label');
    let startX = 0;
    let isDragging = false;

    cardWrapper.addEventListener('touchstart', e => {
        if(!state.isPlaying) return;
        startX = e.touches[0].clientX;
        isDragging = true;
        cardWrapper.style.transition = 'none';
    });

    cardWrapper.addEventListener('touchmove', e => {
        if(!state.isPlaying || !isDragging) return;
        const currentX = e.touches[0].clientX;
        const diff = currentX - startX;
        cardWrapper.style.transform = `translateX(${diff}px) rotate(${diff * 0.05}deg)`;
        
        if (diff > 0) {
            rightLabel.style.opacity = Math.min(1, diff / 80);
            leftLabel.style.opacity = 0;
            showPreview('right');
        } else {
            leftLabel.style.opacity = Math.min(1, Math.abs(diff) / 80);
            rightLabel.style.opacity = 0;
            showPreview('left');
        }
    });

    cardWrapper.addEventListener('touchend', e => {
        if(!state.isPlaying || !isDragging) return;
        isDragging = false;
        const endX = e.changedTouches[0].clientX;
        const diff = endX - startX;
        
        cardWrapper.style.transition = 'transform 0.3s ease-out';

        if (diff > 80) triggerChoice('right');
        else if (diff < -80) triggerChoice('left');
        else {
            cardWrapper.style.transform = '';
            leftLabel.style.opacity = 0;
            rightLabel.style.opacity = 0;
            hidePreview();
        }
    });

    // æ­»äº¡åˆ¤å®š
    function checkGameOver() {
        let reason = null;
        const s = state.stats;
        if (s.energy <= 0) reason = 'energy_low';
        else if (s.energy >= 100) reason = 'energy_high';
        else if (s.health <= 0) reason = 'health_low';
        else if (s.health >= 100) reason = 'health_high';
        else if (s.supplies <= 0) reason = 'supplies_low';
        else if (s.supplies >= 100) reason = 'supplies_high';
        else if (s.sanity <= 0) reason = 'sanity_low';
        else if (s.sanity >= 100) reason = 'sanity_high';

        if (reason) {
            state.isPlaying = false;
            const info = DEATHS[reason];
            document.getElementById('death-title').innerText = info.title;
            document.getElementById('death-desc').innerText = info.desc;
            document.getElementById('final-score').innerText = state.distance;
            document.getElementById('game-over-screen').classList.remove('hidden');
            return true;
        }
        return false;
    }

    function checkVictory() {
        if (state.distance >= CONFIG.totalDistance) {
            state.isPlaying = false;
            document.getElementById('victory-screen').classList.remove('hidden');
            return true;
        }
        return false;
    }

    // åˆå§‹åŒ–
    drawCardImage('event');
    document.getElementById('dist-display').innerText = CONFIG.totalDistance;

</script>
</body>
</html>